<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор изображений с сохранением лица</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #e6e6e6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            background-color: #161b22;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            width: 100%;
            border: 1px solid #30363d;
        }
        .file-input-label {
            display: block;
            background-color: #21262d;
            border: 2px dashed #30363d;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .file-input-label:hover {
            background-color: #2e343b;
            border-color: #555c65;
        }
        .image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        .image-box {
            flex: 1 1 300px;
            max-width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #30363d;
            background-color: #010409;
            text-align: center;
            padding: 1rem;
        }
        .image-box img {
            max-width: 100%;
            height: auto;
            border-radius: 0.25rem;
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-3xl font-bold text-center mb-4 text-purple-400">
        Генератор изображений с сохранением лица
    </h1>
    <p class="text-center text-gray-400 mb-6">
        Загрузите изображение и опишите, что вы хотите сгенерировать, не меняя лица.
    </p>

    <form id="imageForm" class="space-y-4">
        <div>
            <label for="imageUpload" class="file-input-label">
                <span id="file-name">Нажмите, чтобы загрузить изображение</span>
                <input type="file" id="imageUpload" class="hidden" accept="image/*" required>
            </label>
        </div>
        <div>
            <label for="prompt" class="block text-sm font-medium mb-1">
                Текстовое описание:
            </label>
            <textarea id="prompt" rows="3" class="w-full bg-[#21262d] border border-[#30363d] rounded-md p-2 focus:outline-none focus:border-purple-500" placeholder="Например: 'Человек в осеннем лесу, в костюме космонавта'"></textarea>
        </div>
        <button type="submit" id="generateBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
            Сгенерировать
        </button>
    </form>

    <div id="statusMessage" class="mt-4 text-center"></div>

    <div class="image-container">
        <div id="uploadedImageContainer" class="image-box hidden">
            <h3 class="text-sm font-semibold mb-2 text-gray-300">Загруженное изображение:</h3>
            <img id="uploadedImage" src="" alt="Загруженное изображение">
        </div>
        <div id="generatedImagesContainer" class="flex flex-wrap gap-4 justify-center">
            <div id="generatedImageContainer1" class="image-box hidden">
                <h3 class="text-sm font-semibold mb-2 text-gray-300">Сгенерированное изображение 1:</h3>
                <img id="generatedImage1" src="" alt="Сгенерированное изображение 1">
            </div>
            <div id="generatedImageContainer2" class="image-box hidden">
                <h3 class="text-sm font-semibold mb-2 text-gray-300">Сгенерированное изображение 2:</h3>
                <img id="generatedImage2" src="" alt="Сгенерированное изображение 2">
            </div>
            <div id="generatedImageContainer3" class="image-box hidden">
                <h3 class="text-sm font-semibold mb-2 text-gray-300">Сгенерированное изображение 3:</h3>
                <img id="generatedImage3" src="" alt="Сгенерированное изображение 3">
            </div>
            <div id="generatedImageContainer4" class="image-box hidden">
                <h3 class="text-sm font-semibold mb-2 text-gray-300">Сгенерированное изображение 4:</h3>
                <img id="generatedImage4" src="" alt="Сгенерированное изображение 4">
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const imageForm = document.getElementById('imageForm');
        const imageUpload = document.getElementById('imageUpload');
        const promptInput = document.getElementById('prompt');
        const generateBtn = document.getElementById('generateBtn');
        const statusMessage = document.getElementById('statusMessage');
        const fileNameSpan = document.getElementById('file-name');
        const uploadedImageContainer = document.getElementById('uploadedImageContainer');
        const uploadedImage = document.getElementById('uploadedImage');
        const generatedImagesContainer = document.getElementById('generatedImagesContainer');
        const generatedImageContainers = [
            document.getElementById('generatedImageContainer1'),
            document.getElementById('generatedImageContainer2'),
            document.getElementById('generatedImageContainer3'),
            document.getElementById('generatedImageContainer4')
        ];
        const generatedImages = [
            document.getElementById('generatedImage1'),
            document.getElementById('generatedImage2'),
            document.getElementById('generatedImage3'),
            document.getElementById('generatedImage4')
        ];

        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=`;
        
        // Вставьте сюда свой ключ API, полученный в Google AI Studio.
        // Замените YOUR_API_KEY на ваш ключ.
        const API_KEY = "AIzaSyC-OOKttJ2p_-r_UKqghQnT_egmdnv8UDg";

        // Helper function to convert a file to a Base64 string
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        };

        // File input change event handler
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                fileNameSpan.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImage.src = e.target.result;
                    uploadedImageContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Form submission event handler
        imageForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!imageUpload.files[0]) {
                statusMessage.textContent = 'Пожалуйста, сначала загрузите изображение.';
                return;
            }
            if (API_KEY === "YOUR_API_KEY" || API_KEY === "") {
                statusMessage.textContent = 'Ошибка: Пожалуйста, вставьте ваш ключ API в код.';
                return;
            }

            const prompt = promptInput.value || 'Сгенерируйте похожее изображение с другим фоном';
            const file = imageUpload.files[0];

            generateBtn.disabled = true;
            generateBtn.textContent = 'Генерирую...';
            statusMessage.innerHTML = `<div class="flex justify-center items-center"><div class="loader"></div></div>`;
            generatedImagesContainer.querySelectorAll('.image-box').forEach(el => el.classList.add('hidden'));

            try {
                const base64ImageData = await fileToBase64(file);
                const generatePromises = [];
                const maxRetries = 3;

                for (let i = 0; i < 4; i++) {
                    const makeApiCall = async (retries = 0) => {
                        const payload = {
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    {
                                        inlineData: {
                                            mimeType: file.type,
                                            data: base64ImageData
                                        }
                                    }
                                ]
                            }],
                            generationConfig: {
                                responseModalities: ['IMAGE']
                            },
                            // Instruction to the model to preserve the face
                            systemInstruction: {
                                parts: [{
                                    text: "The most important instruction is to maintain the original face from the input image. The face must be preserved exactly. Do not change any facial features, expression, or skin texture."
                                }]
                            }
                        };

                        try {
                            const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });

                            if (!response.ok) {
                                if (response.status === 429 && retries < maxRetries) {
                                    const delay = Math.pow(2, retries) * 1000;
                                    await new Promise(res => setTimeout(res, delay));
                                    return makeApiCall(retries + 1);
                                }
                                const error = await response.json();
                                // More specific error handling for the API key error
                                if (response.status === 400 && error.error?.message.includes("API key not valid")) {
                                    throw new Error("Ваш ключ API недействителен. Пожалуйста, получите новый ключ в Google AI Studio.");
                                }
                                throw new Error(error.error.message || `API failure with status: ${response.status}`);
                            }

                            const result = await response.json();
                            const part = result?.candidates?.[0]?.content?.parts?.[0];
                            if (part && part.inlineData && part.inlineData.data) {
                                return `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                            } else {
                                throw new Error('No image data in response.');
                            }

                        } catch (error) {
                            console.error(`Attempt ${retries + 1} failed for image ${i + 1}:`, error);
                            if (retries < maxRetries) {
                                const delay = Math.pow(2, retries) * 1000;
                                await new Promise(res => setTimeout(res, delay));
                                return makeApiCall(retries + 1);
                            }
                            throw error;
                        }
                    };
                    generatePromises.push(makeApiCall());
                }

                const results = await Promise.all(generatePromises);
                
                results.forEach((imageUrl, index) => {
                    if (imageUrl && generatedImages[index] && generatedImageContainers[index]) {
                        generatedImages[index].src = imageUrl;
                        generatedImageContainers[index].classList.remove('hidden');
                    }
                });
                statusMessage.textContent = 'Изображения успешно сгенерированы!';

            } catch (error) {
                console.error('Error:', error);
                statusMessage.textContent = `Ошибка: ${error.message}`;
                generatedImages.forEach(img => img.src = '');
                generatedImageContainers.forEach(el => el.classList.add('hidden'));
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Сгенерировать';
            }
        });
    });
</script>
</body>
</html>